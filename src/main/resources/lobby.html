<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full Steam Game Lobby</title>
    <meta name="description"
          content="Full Steam is a multiplayer top-down combat game featuring multiple weapons, game modes, vehicles, and tactical combat.">
    <meta name="keywords"
          content="top down, multiplayer, vehicles, team battles, free-for-all, browser game, websockets, io">
    <meta property="og:title" content="Full Steam - Multiplayer Top-Down Tactical Combat">
    <meta property="og:description"
          content="Full Steam is a multiplayer top-down combat game featuring multiple weapons, game modes, vehicles, and tactical combat.">
    <meta property="og:type" content="website">
    <meta name="game:category" content="Multiplayer Shooter">
    <link rel="stylesheet" type="text/css" href="unified.css">
</head>
<body>
<div id="lobby-wrapper">
    <h1>Full Steam</h1>

    <div id="stats-bar">
        <div class="stat-item">
            <span class="stat-value" id="player-count-value">0</span>
            <div class="stat-label">Players Online</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="games-count-value">0</span>
            <div class="stat-label">Active Games</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="server-status">üü¢</span>
            <div class="stat-label">Server Status</div>
        </div>
    </div>

    <h2>Create New Game</h2>
    <div id="create-buttons">
        <div class="loading">Loading game types...</div>
    </div>

    <h2>Join Active Games</h2>
    <ul id="games-list">
        <li class="loading">Loading games...</li>
    </ul>
</div>

<script type="text/javascript">
    const gamesList = document.getElementById('games-list');
    const createButtons = document.getElementById('create-buttons');
    const playerCountValue = document.getElementById('player-count-value');
    const gamesCountValue = document.getElementById('games-count-value');
    const serverStatus = document.getElementById('server-status');

    let lastUpdateTime = Date.now();

    function fetchLobbyInfo() {
        fetch('/api/games')
            .then(response => response.json())
            .then(lobbyInfo => {
                updateLobby(lobbyInfo);
                updateServerStatus(true);
                lastUpdateTime = Date.now();
            })
            .catch(error => {
                console.error('Error fetching lobby info:', error);
                updateServerStatus(false);
                showErrorState();
            });
    }

    function updateServerStatus(isOnline) {
        if (isOnline) {
            serverStatus.textContent = 'üü¢';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Online';
        } else {
            serverStatus.textContent = 'üî¥';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Offline';
        }
    }

    function showErrorState() {
        gamesList.innerHTML = `
            <li class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <div><strong>Connection Error</strong></div>
                <div>Unable to connect to game server. Please check your connection and try again.</div>
            </li>
        `;
        createButtons.innerHTML = `
            <div class="empty-state" style="margin: 0;">
                <div>Game creation unavailable</div>
            </div>
        `;
    }

    function updateLobby(lobbyInfo) {
        // Update stats bar
        playerCountValue.textContent = lobbyInfo.globalPlayerCount || 0;
        gamesCountValue.textContent = lobbyInfo.activeGames ? lobbyInfo.activeGames.length : 0;

        // Update "Create Game" buttons
        createButtons.innerHTML = '';
        if (lobbyInfo.gameTypes && lobbyInfo.gameTypes.length > 0) {
            lobbyInfo.gameTypes.forEach(gameType => {
                const button = document.createElement('button');
                button.textContent = gameType;
                button.onclick = () => createGame(gameType);
                createButtons.appendChild(button);
            });
        } else {
            createButtons.innerHTML = `
                <div class="empty-state" style="margin: 0;">
                    <div>No game types available</div>
                </div>
            `;
        }

        // Update active games list
        gamesList.innerHTML = '';
        if (lobbyInfo.activeGames && lobbyInfo.activeGames.length > 0) {
            lobbyInfo.activeGames.forEach(game => {
                const listItem = document.createElement('li');
                listItem.className = 'game-item';

                const isFull = (game.playerCount || 0) >= game.maxPlayers;
                const gameAge = getGameAge(game.createdTime);
                const playerPercentage = Math.round(((game.playerCount || 0) / game.maxPlayers) * 100);

                listItem.innerHTML = `
                    <div class="game-header">
                        <div class="game-type">${game.gameType}</div>
                        <div class="game-status ${isFull ? 'full' : ''}">${isFull ? 'Full' : 'Open'}</div>
                    </div>
                    <div class="game-info">
                        <div class="info-item">
                            <span class="info-icon">üë•</span>
                            <div>
                                <span class="info-label">Players:</span>
                                <span class="info-value player-indicator">
                                    <span class="player-dot ${isFull ? 'full' : ''}"></span>
                                    ${game.playerCount || 0}/${game.maxPlayers} (${playerPercentage}%)
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üéÆ</span>
                            <div>
                                <span class="info-label">Game ID:</span>
                                <span class="info-value">${game.gameId}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div>
                                <span class="info-label">Duration:</span>
                                <span class="info-value">${gameAge}</span>
                            </div>
                        </div>
                    </div>
                    <div class="game-actions">
                        ${!isFull ? `<button class="join-button" onclick="joinGame('${game.gameId}', '${game.gameType}')">üéØ Join Game</button>` : 
                          `<button class="join-button" disabled>Game Full</button>`}
                        <button class="join-button spectate-button" onclick="spectateGame('${game.gameId}')">üëÅÔ∏è Spectate</button>
                    </div>
                `;
                gamesList.appendChild(listItem);
            });
        } else {
            gamesList.innerHTML = `
                <li class="empty-state">
                    <div><strong>No Active Games</strong></div>
                    <div>Be the first to create a game! Click one of the "Create Game" buttons above.</div>
                </li>
            `;
        }
    }

    function getGameAge(createdTime) {
        if (!createdTime) return 'Unknown';
        
        const now = Date.now();
        const created = typeof createdTime === 'string' ? new Date(createdTime).getTime() : createdTime;
        const diffMinutes = Math.floor((now - created) / (1000 * 60));
        
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ${diffMinutes % 60}m ago`;
        
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ${diffHours % 24}h ago`;
    }

    function joinGame(gameId, gameType) {
        window.location.href = `/config.html?gameId=${gameId}&gameType=${gameType}`;
    }

    function createGame(gameType) {
        window.location.href = `/config.html?gameType=${gameType}`;
    }

    function spectateGame(gameId) {
        window.location.href = `/config.html?spectate=true&gameId=${gameId}`;
    }

    // Add connection status monitoring
    function checkConnectionHealth() {
        const timeSinceLastUpdate = Date.now() - lastUpdateTime;
        if (timeSinceLastUpdate > 10000) { // 10 seconds without update
            updateServerStatus(false);
        }
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'F5' || (event.ctrlKey && event.key === 'r')) {
            event.preventDefault();
            fetchLobbyInfo();
        }
    });

    // Initialize page
    fetchLobbyInfo();
    
    // Refresh every 3 seconds for better responsiveness
    setInterval(fetchLobbyInfo, 3000);
    
    // Check connection health every 5 seconds
    setInterval(checkConnectionHealth, 5000);

    // Add page visibility API support for better performance
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            fetchLobbyInfo(); // Refresh when user comes back to tab
        }
    });
</script>
</body>
</html>
