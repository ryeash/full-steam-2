<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full Steam Game Lobby</title>
    <meta name="description"
          content="Full Steam is a multiplayer top-down combat game featuring multiple weapons, game modes, vehicles, and tactical combat.">
    <meta name="keywords"
          content="top down, multiplayer, vehicles, team battles, free-for-all, browser game, websockets, io">
    <meta property="og:title" content="Full Steam - Multiplayer Top-Down Tactical Combat">
    <meta property="og:description"
          content="Full Steam is a multiplayer top-down combat game featuring multiple weapons, game modes, vehicles, and tactical combat.">
    <meta property="og:type" content="website">
    <meta name="game:category" content="Multiplayer Shooter">
    <link rel="stylesheet" type="text/css" href="unified.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal:not(.hidden) {
            display: flex;
        }
        
        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff88;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #00ff88;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
        }
        
        .modal-close:hover {
            color: #ff4444;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
        }
        
        .config-section h3 {
            margin: 0 0 15px 0;
            color: #00ff88;
            font-size: 1.1em;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item:last-child {
            margin-bottom: 0;
        }
        
        .config-item label {
            display: block;
            color: #ccc;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .config-item input,
        .config-item select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 1em;
        }
        
        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 2px solid #444;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-button.cancel {
            background: #555;
            color: #fff;
        }
        
        .modal-button.cancel:hover {
            background: #666;
        }
        
        .modal-button.create {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
        }
        
        .modal-button.create:hover {
            background: linear-gradient(45deg, #00cc66, #00aa44);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
        }
        
        #create-buttons button.custom-game {
            background: linear-gradient(45deg, #ff9500, #ff6600);
            border: 2px solid #ff9500;
        }
        
        #create-buttons button.custom-game:hover {
            background: linear-gradient(45deg, #ff6600, #ff4400);
            border-color: #ff6600;
        }
    </style>
</head>
<body>
<div id="lobby-wrapper">
    <h1>Full Steam</h1>

    <div id="stats-bar">
        <div class="stat-item">
            <span class="stat-value" id="player-count-value">0</span>
            <div class="stat-label">Players Online</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="games-count-value">0</span>
            <div class="stat-label">Active Games</div>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="server-status">üü¢</span>
            <div class="stat-label">Server Status</div>
        </div>
    </div>

    <h2>Create New Game</h2>
    <div id="create-buttons">
        <div class="loading">Loading game types...</div>
    </div>

    <h2>Join Active Games</h2>
    <ul id="games-list">
        <li class="loading">Loading games...</li>
    </ul>
</div>

<!-- Custom Game Configuration Modal -->
<div id="custom-game-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è Custom Game Configuration</h2>
            <button class="modal-close" onclick="closeCustomGameModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="config-grid">
                <div class="config-section">
                    <h3>üéÆ Game Settings</h3>
                    <div class="config-item">
                        <label for="maxPlayers">Max Players:</label>
                        <input type="number" id="maxPlayers" min="2" max="50" value="10">
                    </div>
                    <div class="config-item">
                        <label for="teamCount">Team Mode:</label>
                        <select id="teamCount">
                            <option value="0">Free For All</option>
                            <option value="2" selected>2 Teams</option>
                            <option value="3">3 Teams</option>
                            <option value="4">4 Teams</option>
                        </select>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>üó∫Ô∏è World Settings</h3>
                    <div class="config-item">
                        <label for="worldWidth">World Width:</label>
                        <input type="number" id="worldWidth" min="1000" max="5000" step="100" value="2000">
                    </div>
                    <div class="config-item">
                        <label for="worldHeight">World Height:</label>
                        <input type="number" id="worldHeight" min="1000" max="5000" step="100" value="2000">
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>‚öîÔ∏è Player Settings</h3>
                    <div class="config-item">
                        <label for="playerSpeed">Player Speed:</label>
                        <input type="number" id="playerSpeed" min="50" max="300" step="10" value="150">
                    </div>
                    <div class="config-item">
                        <label for="playerMaxHealth">Max Health:</label>
                        <input type="number" id="playerMaxHealth" min="50" max="500" step="10" value="100">
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-button cancel" onclick="closeCustomGameModal()">Cancel</button>
            <button class="modal-button create" onclick="createCustomGame()">üöÄ Create Game</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    const gamesList = document.getElementById('games-list');
    const createButtons = document.getElementById('create-buttons');
    const playerCountValue = document.getElementById('player-count-value');
    const gamesCountValue = document.getElementById('games-count-value');
    const serverStatus = document.getElementById('server-status');

    let lastUpdateTime = Date.now();

    function fetchLobbyInfo() {
        fetch('/api/games')
            .then(response => response.json())
            .then(lobbyInfo => {
                updateLobby(lobbyInfo);
                updateServerStatus(true);
                lastUpdateTime = Date.now();
            })
            .catch(error => {
                console.error('Error fetching lobby info:', error);
                updateServerStatus(false);
                showErrorState();
            });
    }

    function updateServerStatus(isOnline) {
        if (isOnline) {
            serverStatus.textContent = 'üü¢';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Online';
        } else {
            serverStatus.textContent = 'üî¥';
            serverStatus.parentElement.querySelector('.stat-label').textContent = 'Server Offline';
        }
    }

    function showErrorState() {
        gamesList.innerHTML = `
            <li class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <div><strong>Connection Error</strong></div>
                <div>Unable to connect to game server. Please check your connection and try again.</div>
            </li>
        `;
        createButtons.innerHTML = `
            <div class="empty-state" style="margin: 0;">
                <div>Game creation unavailable</div>
            </div>
        `;
    }

    function updateLobby(lobbyInfo) {
        // Update stats bar
        playerCountValue.textContent = lobbyInfo.globalPlayerCount || 0;
        gamesCountValue.textContent = lobbyInfo.activeGames ? lobbyInfo.activeGames.length : 0;

        // Update "Create Game" buttons
        createButtons.innerHTML = '';
        
        // Add preset game buttons
        const teamBattleButton = document.createElement('button');
        teamBattleButton.textContent = '‚öîÔ∏è Team Battle';
        teamBattleButton.onclick = () => createPresetGame('team-battle');
        createButtons.appendChild(teamBattleButton);
        
        const ffaButton = document.createElement('button');
        ffaButton.textContent = 'üí• Free For All';
        ffaButton.onclick = () => createPresetGame('ffa');
        createButtons.appendChild(ffaButton);
        
        // Add custom game button
        const customButton = document.createElement('button');
        customButton.textContent = '‚öôÔ∏è Custom Game';
        customButton.className = 'custom-game';
        customButton.onclick = () => openCustomGameModal();
        createButtons.appendChild(customButton);

        // Update active games list
        gamesList.innerHTML = '';
        if (lobbyInfo.activeGames && lobbyInfo.activeGames.length > 0) {
            lobbyInfo.activeGames.forEach(game => {
                const listItem = document.createElement('li');
                listItem.className = 'game-item';

                const isFull = (game.playerCount || 0) >= game.maxPlayers;
                const gameAge = getGameAge(game.createdTime);
                const playerPercentage = Math.round(((game.playerCount || 0) / game.maxPlayers) * 100);

                listItem.innerHTML = `
                    <div class="game-header">
                        <div class="game-type">Game ${game.gameId}</div>
                        <div class="game-status ${isFull ? 'full' : ''}">${isFull ? 'Full' : 'Open'}</div>
                    </div>
                    <div class="game-info">
                        <div class="info-item">
                            <span class="info-icon">üë•</span>
                            <div>
                                <span class="info-label">Players:</span>
                                <span class="info-value player-indicator">
                                    <span class="player-dot ${isFull ? 'full' : ''}"></span>
                                    ${game.playerCount || 0}/${game.maxPlayers} (${playerPercentage}%)
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üéÆ</span>
                            <div>
                                <span class="info-label">Game ID:</span>
                                <span class="info-value">${game.gameId}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div>
                                <span class="info-label">Duration:</span>
                                <span class="info-value">${gameAge}</span>
                            </div>
                        </div>
                    </div>
                    <div class="game-actions">
                        ${!isFull ? `<button class="join-button" onclick="joinGame('${game.gameId}')">üéØ Join Game</button>` : 
                          `<button class="join-button" disabled>Game Full</button>`}
                        <button class="join-button spectate-button" onclick="spectateGame('${game.gameId}')">üëÅÔ∏è Spectate</button>
                    </div>
                `;
                gamesList.appendChild(listItem);
            });
        } else {
            gamesList.innerHTML = `
                <li class="empty-state">
                    <div><strong>No Active Games</strong></div>
                    <div>Be the first to create a game! Click one of the "Create Game" buttons above.</div>
                </li>
            `;
        }
    }

    function getGameAge(createdTime) {
        if (!createdTime) return 'Unknown';
        
        const now = Date.now();
        const created = typeof createdTime === 'string' ? new Date(createdTime).getTime() : createdTime;
        const diffMinutes = Math.floor((now - created) / (1000 * 60));
        
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ${diffMinutes % 60}m ago`;
        
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ${diffHours % 24}h ago`;
    }

    function joinGame(gameId) {
        window.location.href = `/config.html?gameId=${gameId}`;
    }

    async function createPresetGame(presetType) {
        let gameConfig;
        
        if (presetType === 'team-battle') {
            gameConfig = {
                maxPlayers: 20,
                teamCount: 4,
                worldWidth: 2500,
                worldHeight: 2500,
                playerSpeed: 150,
                playerMaxHealth: 100,
                playerSize: 10,
                strategicLocationsCount: 5,
                captureRadius: 50,
                captureTime: 3,
                aiCheckIntervalMs: 10000
            };
        } else if (presetType === 'ffa') {
            gameConfig = {
                maxPlayers: 10,
                teamCount: 0,
                worldWidth: 1500,
                worldHeight: 1500,
                playerSpeed: 150,
                playerMaxHealth: 100,
                playerSize: 10,
                strategicLocationsCount: 5,
                captureRadius: 50,
                captureTime: 3,
                aiCheckIntervalMs: 10000
            };
        }
        
        try {
            const response = await fetch('/api/games', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gameConfig)
            });

            if (!response.ok) {
                throw new Error('Failed to create game');
            }

            const result = await response.json();
            window.location.href = `/config.html?gameId=${result.gameId}`;
        } catch (error) {
            console.error('Error creating preset game:', error);
            alert('Failed to create game. Please try again.');
        }
    }

    function spectateGame(gameId) {
        window.location.href = `/config.html?spectate=true&gameId=${gameId}`;
    }

    // Add connection status monitoring
    function checkConnectionHealth() {
        const timeSinceLastUpdate = Date.now() - lastUpdateTime;
        if (timeSinceLastUpdate > 10000) { // 10 seconds without update
            updateServerStatus(false);
        }
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'F5' || (event.ctrlKey && event.key === 'r')) {
            event.preventDefault();
            fetchLobbyInfo();
        }
    });

    // Initialize page
    fetchLobbyInfo();
    
    // Refresh every 3 seconds for better responsiveness
    setInterval(fetchLobbyInfo, 3000);
    
    // Check connection health every 5 seconds
    setInterval(checkConnectionHealth, 5000);

    // Add page visibility API support for better performance
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            fetchLobbyInfo(); // Refresh when user comes back to tab
        }
    });

    // Custom Game Modal Functions
    async function openCustomGameModal() {
        try {
            // Fetch default configuration from server
            const response = await fetch('/api/game-config/default');
            const defaultConfig = await response.json();
            
            // Populate form with default values
            document.getElementById('maxPlayers').value = defaultConfig.maxPlayers;
            document.getElementById('teamCount').value = defaultConfig.teamCount;
            document.getElementById('worldWidth').value = defaultConfig.worldWidth;
            document.getElementById('worldHeight').value = defaultConfig.worldHeight;
            document.getElementById('playerSpeed').value = defaultConfig.playerSpeed;
            document.getElementById('playerMaxHealth').value = defaultConfig.playerMaxHealth;
            
            // Show modal
            document.getElementById('custom-game-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading default config:', error);
            alert('Failed to load configuration. Please try again.');
        }
    }

    function closeCustomGameModal() {
        document.getElementById('custom-game-modal').classList.add('hidden');
    }

    async function createCustomGame() {
        const gameConfig = {
            maxPlayers: parseInt(document.getElementById('maxPlayers').value),
            teamCount: parseInt(document.getElementById('teamCount').value),
            worldWidth: parseFloat(document.getElementById('worldWidth').value),
            worldHeight: parseFloat(document.getElementById('worldHeight').value),
            playerSpeed: parseFloat(document.getElementById('playerSpeed').value),
            playerMaxHealth: parseFloat(document.getElementById('playerMaxHealth').value),
            playerSize: 10.0,
            strategicLocationsCount: 5,
            captureRadius: 50.0,
            captureTime: 3.0,
            aiCheckIntervalMs: 10000
        };

        try {
            const response = await fetch('/api/games', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gameConfig)
            });

            if (!response.ok) {
                throw new Error('Failed to create game');
            }

            const result = await response.json();
            closeCustomGameModal();
            
            // Redirect to weapon config page for the new game
            window.location.href = `/config.html?gameId=${result.gameId}`;
        } catch (error) {
            console.error('Error creating custom game:', error);
            alert('Failed to create custom game. Please try again.');
        }
    }

    // Close modal when clicking outside
    document.getElementById('custom-game-modal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeCustomGameModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCustomGameModal();
        }
    });
</script>
</body>
</html>
